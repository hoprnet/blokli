# Docker Compose configuration for smoke testing blokli
# Tests that blokli can start and become healthy with PostgreSQL and Anvil
#
# Usage:
#   ./run-smoke-test.sh
#   docker compose down -v
#
# Environment variables:
#   REGISTRY_PORT    - Local registry port (default: 5000)
#   BLOKLID_IMAGE    - Docker image to test (default: localhost:5000/bloklid:smoke-test)

services:
  registry:
    image: registry:2
    container_name: blokli-smoke-registry
    ports:
      - "${REGISTRY_PORT:-5000}:5000"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 5000 || exit 1"]
      interval: 2s
      timeout: 5s
      retries: 5
    networks:
      - smoke-test

  postgres:
    image: postgres:18-alpine
    container_name: blokli-smoke-postgres
    environment:
      POSTGRES_USER: bloklid
      POSTGRES_PASSWORD: bloklid_smoke_test
      POSTGRES_DB: bloklid
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bloklid"]
      interval: 2s
      timeout: 5s
      retries: 10
    networks:
      - smoke-test

  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: blokli-smoke-anvil
    entrypoint: ["anvil"]
    command:
      - "--host"
      - "0.0.0.0"
      - "--block-time"
      - "1"
      - "--accounts"
      - "10"
      - "--balance"
      - "10000"
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 2s
      timeout: 5s
      retries: 10
    networks:
      - smoke-test

  bloklid:
    image: ${BLOKLID_IMAGE:-localhost:5000/bloklid:smoke-test}
    container_name: blokli-smoke-bloklid
    depends_on:
      registry:
        condition: service_healthy
      postgres:
        condition: service_healthy
      anvil:
        condition: service_healthy
    environment:
      RUST_LOG: info,blokli=debug,sea_orm_migration=debug
    volumes:
      - ./config-smoke.toml:/config.toml:ro
    ports:
      - "3064:3064"
    command: ["-c", "/config.toml"]
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3064/healthz"]
      interval: 5s
      timeout: 10s
      retries: 30
      start_period: 30s
    networks:
      - smoke-test

networks:
  smoke-test:
    driver: bridge
