erDiagram
    account {
        int id PK "Primary key"
        binary(20) chain_key "Chain key (NOT NULL)"
        string(64) packet_key "Packet key (hex representation, NOT NULL)"
        binary(20) safe_address FK "Foreign key to hopr safe"
        bigint published_block "Published block (NOT NULL)"
        bigint published_tx_index "Published tx index (NOT NULL)"
        bigint published_log_index "Published log index (NOT NULL)"
    }

    announcement {
        int id PK "Primary key"
        int account_id FK "Foreign key to account (NOT NULL)"
        string multiaddress "Multiaddress (NOT NULL)"
        bigint published_block "Published block (NOT NULL)"
        bigint published_tx_index "Published tx index (NOT NULL)"
        bigint published_log_index "Published log index (NOT NULL)"
    }

    channel {
        int id PK "Primary key"
        string(64) concrete_channel_id UK "Unique channel identifier (hex representation, NOT NULL)"
        int source FK "Source account ID (Foreign key to account, NOT NULL)"
        int destination FK "Destination account ID (Foreign key to account, NOT NULL)"
        binary(12) balance "Channel balance (NOT NULL)"
        int status "Channel status (NOT NULL)"
        bigint epoch "Epoch (NOT NULL, default is 1)"
        bigint ticket_index "Ticket index (NOT NULL, default is 0)"
        datetime closure_time "Closure timestamp"
        bool corrupted_state "Corrupted state flag (NOT NULL, default is false)"
    }

    hopr_balance {
        int id PK "Primary key"
        binary(20) address UK "Unique address (NOT NULL)"
        binary(12) balance "wxHOPR token balance (NOT NULL)"
        bigint last_changed_block "Last changed block (NOT NULL)"
        bigint last_changed_tx_index "Last changed tx index (NOT NULL)"
        bigint last_changed_log_index "Last changed log index (NOT NULL)"
    }

    native_balance {
        int id PK "Primary key"
        binary(20) address UK "Unique address (NOT NULL)"
        binary(12) balance "Native token balance (NOT NULL)"
        bigint last_changed_block "Last changed block (NOT NULL)"
        bigint last_changed_tx_index "Last changed tx index (NOT NULL)"
        bigint last_changed_log_index "Last changed log index (NOT NULL)"
    }

    chain_info {
        int id PK "Primary key"
        bigint last_indexed_block "Last indexed block"
        binary(12) ticket_price "Ticket price"
        binary(32) channels_dst "Channels destination"
        binary(32) ledger_dst "Ledger destination"
        binary(32) safe_registry_dst "Safe registry destination"
        float min_incoming_ticket_win_prob "Min incoming ticket win probability"
    }

    log {
        int id PK "Primary key"
        bigint tx_index "Transaction index (NOT NULL)"
        bigint log_index "Log index (NOT NULL)"
        bigint block_number "Block number (NOT NULL)"
        binary(32) block_hash "Block hash (hex representation, NOT NULL)"
        binary(32) transaction_hash "Transaction hash (hex representation, NOT NULL)"
        binary(20) address "Address (NOT NULL)"
        binary topics "Topics (NOT NULL)"
        binary data "Data (NOT NULL)"
        bool removed "Removed flag (default is false)"
    }
    %% Composite unique constraint: UNIQUE(block_number, tx_index, log_index)

    log_status {
        int id PK "Primary key"
        int log_id FK "Foreign key to log (NOT NULL)"
        bigint tx_index "Transaction index (NOT NULL)"
        bigint log_index "Log index (NOT NULL)"
        bigint block_number "Block number (NOT NULL)"
        bool processed "Processed flag (default is false)"
        datetime processed_at "Processing timestamp"
        binary(32) checksum "Checksum"
    }
    %% Composite unique constraint: UNIQUE(block_number, tx_index, log_index)

    log_topic_info {
        int id PK "Primary key"
        binary(20) address "Contract address (NOT NULL)"
        string(64) topic "topic (NOT NULL)"
    }

    hopr_safe_contract {
        int id PK "Primary key"
        binary(20) address UK "Unique contract address (NOT NULL)"
        bigint deployed_block "Deployed block (NOT NULL)"
        bigint deployed_tx_index "Deployed tx index (NOT NULL)"
        bigint deployed_log_index "Deployed log index (NOT NULL)"
    }

    %% ========================================
    %% RELATIONSHIPS
    %% ========================================

    account ||--o{ announcement : "has many"
    account ||--o| hopr_balance : "has 0 or 1"
    account ||--o| native_balance : "has 0 or 1"
    account ||--o{ channel : "source of many"
    account ||--o{ channel : "destination of many"
    account ||--o| hopr_safe_contract : "has 0 or 1"
    log ||--o| log_status : "has 0 or 1"
