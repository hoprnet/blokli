name: Security Scan
env:
  RUST_BACKTRACE: "1"
  CARGO_TERM_COLOR: always
permissions:
  contents: read
  security-events: write
on:
  workflow_call:
    inputs:
      image_url:
        description: "Full Docker image URL to scan (e.g., registry.example.com/bloklid:1.0.0-amd64)"
        required: true
        type: string
      architecture:
        description: "Architecture of the image (amd64 or arm64)"
        required: true
        type: string
jobs:
  security-scan:
    name: Security Scan (${{ inputs.architecture }})
    runs-on: self-hosted-hoprnet-bigger
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          disable-sudo: true
          egress-policy: audit
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Install Nix
        uses: cachix/install-nix-action@7be5dee1421f63d07e71ce6e0a9f8a4b07c2a487 # v31
      - name: Use Nix Cache
        uses: cachix/cachix-action@0fc020193b5a1fa3ac4575aa3a7d3aa6a35435ad # v16
        with:
          name: blokli
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        env:
          USER: runner
      - name: Setup GCP
        id: gcp
        uses: hoprnet/hopr-workflows/actions/setup-gcp@12c56020e16036982e6cc529848edeedfc705865 # master
        with:
          google-credentials: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY }}
          login-artifact-registry: 'true'
          install-sdk: 'false'
      - name: Run Trivy vulnerability scanner (Nix-based)
        run: |
          # Use nix-lib Trivy scan with pre-fetched database
          # This generates both SARIF and table reports
          if [ "${{ inputs.architecture }}" = "amd64" ]; then
            nix build -L .#bloklid-docker-amd64-scan
            SCAN_PATH="./result"
          else
            nix build -L .#bloklid-docker-arm64-scan
            SCAN_PATH="./result"
          fi

          # Copy SARIF report for upload
          cp "$SCAN_PATH/scan-report.sarif" trivy-results-${{ inputs.architecture }}.sarif

          # Display table summary
          echo "=== Trivy Scan Summary ==="
          cat "$SCAN_PATH/scan-summary.txt" || echo "No vulnerabilities summary available"
          echo "=========================="
      - name: Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results-${{ inputs.architecture }}.sarif
          category: trivy-${{ inputs.architecture }}
      - name: Smoke test - Verify container starts
        run: |
          # Pull the image for smoke testing
          docker pull "${{ inputs.image_url }}"

          # Start container in background with --help flag
          # This verifies the entrypoint works and binary is functional
          container_id=$(docker run -d "${{ inputs.image_url }}" --help)

          # Wait for container to complete (max 30 seconds)
          timeout=30
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            status=$(docker inspect --format='{{.State.Status}}' $container_id)
            if [ "$status" = "exited" ]; then
              break
            fi
            sleep 1
            elapsed=$((elapsed + 1))
          done

          # Check exit code
          exit_code=$(docker inspect --format='{{.State.ExitCode}}' $container_id)

          # Show logs for debugging
          echo "=== Container logs ==="
          docker logs $container_id
          echo "======================"

          # Cleanup
          docker rm $container_id

          # Verify success
          if [ "$exit_code" -ne 0 ]; then
            echo "Error: Container exited with code $exit_code"
            exit 1
          fi

          echo "âœ“ Smoke test passed - container started successfully"
      - name: Generate SBOM (Nix-based)
        if: always()
        run: |
          # Use nix-lib SBOM generation with Syft
          # Generates both SPDX and CycloneDX formats
          if [ "${{ inputs.architecture }}" = "amd64" ]; then
            nix build -L .#bloklid-docker-amd64-sbom
            SBOM_PATH="./result"
          else
            nix build -L .#bloklid-docker-arm64-sbom
            SBOM_PATH="./result"
          fi

          # Copy CycloneDX SBOM for compatibility
          cp "$SBOM_PATH/sbom.cyclonedx.json" sbom-${{ inputs.architecture }}.json
      - name: Upload SBOM artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ inputs.architecture }}
          path: |
            sbom-${{ inputs.architecture }}.json
            result/sbom.*.json
          retention-days: 90
