name: Security Scan
env:
  RUST_BACKTRACE: "1"
  CARGO_TERM_COLOR: always
permissions:
  contents: read
  security-events: write
on:
  workflow_call:
    inputs:
      image_url:
        description: "Full Docker image URL to scan (e.g., registry.example.com/bloklid:1.0.0-amd64)"
        required: true
        type: string
      architecture:
        description: "Architecture of the image (amd64 or arm64)"
        required: true
        type: string
jobs:
  security-scan:
    name: Security Scan (${{ inputs.architecture }})
    runs-on: self-hosted-hoprnet-bigger
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          disable-sudo: true
          egress-policy: audit
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Setup GCP
        id: gcp
        uses: hoprnet/hopr-workflows/actions/setup-gcp@12c56020e16036982e6cc529848edeedfc705865 # master
        with:
          google-credentials: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY }}
          login-artifact-registry: 'true'
          install-sdk: 'false'
      - name: Run Trivy vulnerability scanner
        run: |
          # Run Trivy using Docker to avoid dependency issues on self-hosted runner
          docker run --rm \
            -v "$(pwd):/output" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasecurity/trivy:latest image \
            --format sarif \
            --output "/output/trivy-results-${{ inputs.architecture }}.sarif" \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            "${{ inputs.image_url }}"
      - name: Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@d3ced5c96c16c4332e2a61eb6f3649d6f1b20bb8 # v3.31.5
        with:
          sarif_file: trivy-results-${{ inputs.architecture }}.sarif
          category: trivy-${{ inputs.architecture }}
      - name: Smoke test - Verify container starts
        run: |
          # Pull the image for smoke testing
          docker pull "${{ inputs.image_url }}"

          # Start container in background with --help flag
          # This verifies the entrypoint works and binary is functional
          container_id=$(docker run -d "${{ inputs.image_url }}" --help)

          # Wait for container to complete (max 30 seconds)
          timeout=30
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            status=$(docker inspect --format='{{.State.Status}}' "$container_id")
            if [ "$status" = "exited" ]; then
              break
            fi
            sleep 1
            elapsed=$((elapsed + 1))
          done

          # Check exit code
          exit_code=$(docker inspect --format='{{.State.ExitCode}}' "$container_id")

          # Show logs for debugging
          echo "=== Container logs ==="
          docker logs "$container_id"
          echo "======================"

          # Cleanup
          docker rm "$container_id"

          # Verify success
          if [ "$exit_code" -ne 0 ]; then
            echo "Error: Container exited with code $exit_code"
            exit 1
          fi

          echo "âœ“ Smoke test passed - container started successfully"
      - name: Generate SBOM
        if: always()
        run: |
          # Generate SBOM using Trivy via Docker
          docker run --rm \
            -v "$(pwd):/output" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasecurity/trivy:latest image \
            --format cyclonedx \
            --output "/output/sbom-${{ inputs.architecture }}.json" \
            "${{ inputs.image_url }}"
      - name: Upload SBOM artifacts
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sbom-${{ inputs.architecture }}
          path: sbom-${{ inputs.architecture }}.json
          retention-days: 90
