name: Merge PR
on:
  pull_request:
    types:
      - closed
      # - synchronize
concurrency:
  group: merge
  cancel-in-progress: false
jobs:
  build-docker:
    name: Build Docker
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/build-docker.yaml
    with:
      source_branch: ${{ github.event.pull_request.base.ref }}
      version_type: "pr"
    secrets: inherit
  tag-latest:
    name: Tag Docker manifest as latest
    runs-on: self-hosted-hoprnet-small
    needs: build-docker
    if: github.event.pull_request.merged == true
    steps:
      - name: Setup GCP
        uses: hoprnet/hopr-workflows/actions/setup-gcp@12c56020e16036982e6cc529848edeedfc705865 # master
        with:
          google-credentials: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY }}
          login-artifact-registry: 'true'
          install-sdk: 'true'
      - name: Tag manifest as latest
        run: |
          # Get the source manifest URL from build-docker output
          SOURCE_MANIFEST="${{ needs.build-docker.outputs.manifest_url }}"
          LATEST_TAG="${{ vars.DOCKER_IMAGE_REGISTRY }}/bloklid:latest"

          echo "Tagging $SOURCE_MANIFEST as latest"
          gcloud artifacts docker tags add \
            "$SOURCE_MANIFEST" \
            "$LATEST_TAG"

          echo "Successfully tagged $SOURCE_MANIFEST as latest"
