#################################################################################
# Pipeline to build on pull requests #
#################################################################################
name: Build
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
concurrency:
  group: ${{ github.ref }}-build
  cancel-in-progress: true
env:
  CARGO_TERM_COLOR: always
jobs:
  build-docker:
    name: Build Docker
    uses: hoprnet/hopr-workflows/.github/workflows/build-docker-image.yaml@ausias/fix-actions
    strategy:
      matrix:
        include:
          - architecture: x86_64-linux
            command: nix run -L .#bloklid-docker-upload-amd64
            # Disabled until GitHub runner supports aarch64
            # - architecture: aarch64-linux
            #   command: nix run -L .#bloklid-docker-upload-aarch64
    with:
      source_branch: ${{ github.event.pull_request.head.ref || github.ref }}
      version_type: "commit"
      architecture: ${{ matrix.architecture }}
      cachix_cache_name: "blokli"
      build_file: "bloklid/Cargo.toml"
      build_command: ${{ matrix.command }}
      docker_image_name: "bloklid"
    secrets:
      gcp_service_account: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY}}
      cachix_auth_token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
      docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
  build-docker-manifest:
    name: Docker Manifest
    needs: build-docker
    uses: hoprnet/hopr-workflows/.github/workflows/create-docker-manifest.yaml@ausias/fix-actions
    with:
      version_type: "commit"
      docker_image_name: "bloklid"
      docker_version: ${{ needs.build-docker.outputs.docker_version }}
    secrets:
      gcp_service_account: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY}}
      docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
      docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
  build_binaries:
    strategy:
      fail-fast: false
      matrix:
        include:
          - architecture: x86_64-linux
            runner: self-hosted-hoprnet-bigger
            build_command: nix develop --command just build-release x86_64-linux
    name: Binary
    uses: hoprnet/hopr-workflows/.github/workflows/build-binaries.yaml@ausias/fix-actions
    with:
      source_branch: ${{ github.event.pull_request.head.ref || github.ref }}
      version_type: "commit"
      architecture: ${{ matrix.architecture }}
      cachix_cache_name: "blokli"
      build_file: "bloklid/Cargo.toml"
      build_command: ${{ matrix.build_command }}
      binary: bloklid
      runner: ${{ matrix.runner }}
    secrets:
      gcp_service_account: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY}}
      cachix_auth_token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      gpg_private_key: ${{ secrets.GPG_HOPRNET_PRIVATE_KEY }}
  build-client:
    name: Build blokli-client
    runs-on: self-hosted-hoprnet-bigger
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Setup Nix
        uses: hoprnet/hopr-workflows/actions/setup-nix@ausias/fix-actions
        with:
          cache: blokli
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Build blokli-client-dev
        run: nix build -L .#blokli-client-dev --no-link
  smoke-test:
    name: Smoke Test
    needs: build-docker
    uses: ./.github/workflows/smoke-test.yaml
    with:
      image: ${{ vars.DOCKER_IMAGE_REGISTRY }}/bloklid:${{ needs.build-docker.outputs.docker_version }}
    secrets: inherit
  checks:
    name: Checks
    runs-on: self-hosted-hoprnet-bigger
    # Runs in parallel with build-docker - no dependency
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Setup Nix
        uses: hoprnet/hopr-workflows/actions/setup-nix@ausias/fix-actions
        with:
          cache: blokli
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Check formatting and linting
        run: nix develop --command just quick
  test:
    name: Test
    runs-on: self-hosted-hoprnet-bigger
    needs: checks
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Setup Nix
        uses: hoprnet/hopr-workflows/actions/setup-nix@ausias/fix-actions
        with:
          cache: blokli
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Run unit tests
        run: nix develop --command just test
  nextest:
    name: Nextest
    runs-on: self-hosted-hoprnet-bigger
    needs: checks
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Setup Nix
        uses: hoprnet/hopr-workflows/actions/setup-nix@ausias/fix-actions
        with:
          cache: blokli
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Run unit tests using nextest
        run: nix develop --command bash -c "cargo install cargo-nextest && just nextest"
  schema-validation:
    name: Schema Validation
    runs-on: self-hosted-hoprnet-bigger
    needs: checks
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Setup Nix
        uses: hoprnet/hopr-workflows/actions/setup-nix@ausias/fix-actions
        with:
          cache: blokli
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: Generate GraphQL schema
        run: nix develop --command just export-schema-sqlite
      - name: Validate schema against target
        run: nix develop --command uv run scripts/check_schema.py
